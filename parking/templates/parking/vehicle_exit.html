{% extends 'parking/base.html' %}
{% load static %}
{% load parking_tags %}

{% block page_title %}<i class="fas fa-sign-out-alt mr-3"></i>Salida de Vehículos{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-sm-4 py-3 py-md-4">
    <!-- Subtitle -->
    <div class="mb-3 mb-md-4">
        <p class="text-muted small">Ingrese la placa del vehículo o escanee el código de barras</p>
    </div>

    <!-- Content -->
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <!-- Search Form Card -->
            <div id="search-card" class="card border-0 shadow-sm mb-3 mb-md-4">
                <!-- Form Header -->
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-search me-2"></i>
                        Buscar Vehículo
                    </h5>
                </div>

                <!-- Form Content -->
                <div class="card-body p-3 p-sm-4"></div>
                <form id="exit-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">
                            Placa del Vehículo
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-car text-muted"></i>
                            </span>
                            <input type="text" name="identifier" id="identifier" value="{{ placa }}"
                                class="form-control form-control-lg text-uppercase" required
                                placeholder="Ingrese la placa o escanee el código" autofocus>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-search me-2"></i>
                        Buscar Vehículo
                    </button>
                </form>
            </div>
        </div>

        <!-- Result Card -->
        <div id="result" class="card border-0 shadow-sm d-none">
            <!-- Result Header -->
            <div class="card-header bg-light border-0">
                <h5 class="mb-1 fw-bold text-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Resumen de Salida
                </h5>
                <p class="text-muted small mb-0">Complete los datos de pago</p>
            </div>

            <!-- Result Content -->
            <div class="card-body p-3 p-sm-4"></div>
            <div class="mb-4">
                <div class="row g-2 g-sm-3 mb-3">
                    <div class="col-12 col-sm-4">
                        <div class="bg-light rounded p-3 text-center">
                            <small class="text-muted d-block">Placa</small>
                            <strong id="placa" class="h6 mb-0"></strong>
                        </div>
                    </div>
                    <div class="col-12 col-sm-4">
                        <div class="bg-light rounded p-3 text-center">
                            <small class="text-muted d-block">Entrada</small>
                            <strong id="entry_time" class="h6 mb-0"></strong>
                        </div>
                    </div>
                    <div class="col-12 col-sm-4">
                        <div class="bg-light rounded p-3 text-center">
                            <small class="text-muted d-block">Tiempo</small>
                            <strong id="duration" class="h6 mb-0"></strong>
                        </div>
                    </div>
                </div>

                <!-- Desglose de pago -->
                <div class="bg-success bg-opacity-10 rounded border border-success border-opacity-25 p-3">
                    <div id="payment-breakdown" class="mb-2">
                        <!-- Se llenará dinámicamente con JavaScript -->
                    </div>
                    <!-- Total siempre visible -->
                    <div
                        class="d-flex justify-content-between align-items-center border-top border-success border-opacity-25 pt-2">
                        <span class="text-success fw-medium">Total a Pagar:</span>
                        <span class="h4 fw-bold text-success mb-0">$<span id="amount">0.00</span></span>
                    </div>
                </div>
            </div>

            <form id="payment-form" method="POST" action="{% url 'print-exit-ticket' %}">
                {% csrf_token %}
                <input type="hidden" name="ticket_id" id="ticket_id">

                <div class="row g-3">
                    <!-- Amount Received -->
                    <div class="col-12 col-sm-6">
                        <label class="form-label fw-medium">
                            Con cuánto pagó <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-dollar-sign text-muted"></i>
                            </span>
                            <input type="number" name="amount_received" id="amount_received" step="0.01"
                                class="form-control form-control-lg" required placeholder="0.00"
                                onkeyup="setTimeout(calculateChange, 100)" onchange="setTimeout(calculateChange, 100)"
                                oninput="setTimeout(calculateChange, 100)">
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="col-12 col-sm-6">
                        <label class="form-label fw-medium">
                            Forma de pago <span class="text-danger">*</span>
                        </label>
                        <select name="forma_pago" id="forma_pago" class="form-select form-select-lg" required>
                            <option value="efectivo">Efectivo</option>
                            <option value="datafono">Datáfono</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="otro">Otro</option>
                        </select>
                    </div>

                    <!-- Change -->
                    <div class="col-12">
                        <div class="bg-info bg-opacity-10 rounded border border-info border-opacity-25 p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-info fw-medium">Vuelto:</span>
                                <span id="change" class="h5 fw-bold text-info mb-0">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="col-12">
                        <div class="d-grid gap-2 d-sm-flex">
                            <button type="button" class="btn btn-success btn-lg flex-fill" id="btn-cobrar"
                                onclick="debugElements(); processPayment();">
                                <i class="fas fa-cash-register me-2"></i>
                                Cobrar y Imprimir Ticket
                            </button>
                            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-lg flex-fill">
                                <i class="fas fa-home me-2"></i>
                                Volver
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Variables globales
    let currentTicketId = null;
    let currentAmount = 0;

    // Función para verificar elementos
    function debugElements() {
        console.log('=== DEBUG ELEMENTS ===');
        console.log('amount_received:', document.getElementById('amount_received'));
        console.log('amount:', document.getElementById('amount'));
        console.log('ticket_id:', document.getElementById('ticket_id'));
        console.log('change:', document.getElementById('change'));
        console.log('result div:', document.getElementById('result'));
        console.log('======================');
    }

    // Función para calcular el vuelto
    function calculateChange() {
        console.log('Calculating change...');

        try {
            // Verificar que el div result esté visible
            const resultDiv = document.getElementById('result');
            if (!resultDiv || resultDiv.classList.contains('d-none')) {
                console.log('Result div is hidden, skipping change calculation');
                return;
            }

            const amountReceivedInput = document.getElementById('amount_received');
            const amountElement = document.getElementById('amount');
            const changeElement = document.getElementById('change');

            if (!amountReceivedInput || !amountElement || !changeElement) {
                console.log('Required elements not found for change calculation');
                console.log('amountReceivedInput:', !!amountReceivedInput);
                console.log('amountElement:', !!amountElement);
                console.log('changeElement:', !!changeElement);
                return;
            }

            const amountReceived = parseFloat(amountReceivedInput.value) || 0;
            const amountToPay = parseFloat(amountElement.textContent) || 0;
            const change = amountReceived - amountToPay;

            console.log('Amount received:', amountReceived, 'Amount to pay:', amountToPay, 'Change:', change);

            changeElement.textContent = '$' + change.toFixed(2);

            // Cambiar color del vuelto según si es positivo o negativo
            if (change >= 0) {
                changeElement.className = 'font-bold text-green-600 text-base';
            } else {
                changeElement.className = 'font-bold text-red-600 text-base';
            }
        } catch (error) {
            console.error('Error calculating change:', error);
        }
    }

    // Función para procesar el pago
    function processPayment() {
        console.log('Processing payment...');

        try {
            // Verificar que el div result esté visible
            const resultDiv = document.getElementById('result');
            if (!resultDiv || resultDiv.classList.contains('d-none')) {
                alert('Primero debe buscar un vehículo');
                return false;
            }

            const amountReceivedInput = document.getElementById('amount_received');
            const amountElement = document.getElementById('amount');
            const ticketIdInput = document.getElementById('ticket_id');

            if (!amountReceivedInput) {
                alert('No se encontró el campo de monto recibido. Verifique que haya buscado un vehículo primero.');
                return false;
            }

            if (!amountElement) {
                alert('No se encontró el monto a pagar. Verifique que haya buscado un vehículo primero.');
                return false;
            }

            if (!ticketIdInput) {
                alert('No se encontró el ID del ticket. Verifique que haya buscado un vehículo primero.');
                return false;
            }

            const amountReceived = parseFloat(amountReceivedInput.value) || 0;
            const amountToPay = parseFloat(amountElement.textContent) || 0;
            const ticketId = ticketIdInput.value;

            console.log('Payment data:', { amountReceived, amountToPay, ticketId });

            // Validaciones
            if (!ticketId) {
                alert('No se encontró el ID del ticket');
                return false;
            }

            if (!amountReceived || amountReceived <= 0) {
                alert('Debe ingresar un monto válido');
                return false;
            }

            if (amountReceived < amountToPay) {
                alert('El monto pagado debe ser mayor o igual al total a pagar');
                return false;
            }

            // Mostrar loading
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'Procesando pago...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });
            }

            // Enviar formulario
            const form = document.getElementById('payment-form');
            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => {
                    console.log('Payment response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor: ' + response.status);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('Payment result:', result);

                    if (typeof Swal !== 'undefined') {
                        Swal.close();
                    }

                    if (result.success) {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Salida registrada!',
                                text: 'El ticket de salida se abrirá en una nueva pestaña.',
                                confirmButtonColor: '#3B82F6'
                            }).then(() => {
                                // Abrir ticket en nueva pestaña
                                window.open(result.redirect_url, '_blank');

                                // Resetear formularios
                                resetForms();
                            });
                        } else {
                            alert('¡Salida registrada! El ticket se abrirá en una nueva pestaña.');
                            window.open(result.redirect_url, '_blank');
                            resetForms();
                        }
                    } else {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: result.error || 'Error al procesar el pago',
                                confirmButtonColor: '#3B82F6'
                            });
                        } else {
                            alert('Error: ' + (result.error || 'Error al procesar el pago'));
                        }
                    }
                })
                .catch(error => {
                    console.error('Payment error:', error);

                    if (typeof Swal !== 'undefined') {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de conexión',
                            text: 'No se pudo procesar el pago. Intente nuevamente.',
                            confirmButtonColor: '#3B82F6'
                        });
                    } else {
                        alert('Error de conexión: No se pudo procesar el pago. Intente nuevamente.');
                    }
                });

        } catch (error) {
            console.error('Error in processPayment:', error);
            alert('Error al procesar el pago: ' + error.message);
        }

        return false;
    }

    // Función para resetear formularios
    function resetForms() {
        try {
            document.getElementById('payment-form').reset();
            document.getElementById('result').classList.add('d-none');
            document.getElementById('search-card').classList.remove('d-none');
            document.getElementById('exit-form').reset();
            document.getElementById('identifier').focus();
            document.getElementById('change').textContent = '$0.00';
        } catch (error) {
            console.error('Error resetting forms:', error);
        }
    }

    // Función para actualizar el desglose de pago
    function updatePaymentBreakdown(breakdown) {
        const breakdownDiv = document.getElementById('payment-breakdown');
        const amountElement = document.getElementById('amount');

        if (!breakdownDiv || !amountElement) return;

        // Actualizar el elemento amount
        if (breakdown && breakdown.total_amount) {
            amountElement.textContent = breakdown.total_amount.toFixed(2);
        }

        // Actualizar el desglose
        if (breakdown && breakdown.has_tax) {
            breakdownDiv.innerHTML =
                '<div class="flex justify-between items-center text-sm">' +
                '<span class="text-green-700">Subtotal:</span>' +
                '<span class="font-semibold text-green-800">' + (breakdown.subtotal_formatted || '$' + breakdown.subtotal.toFixed(2)) + '</span>' +
                '</div>' +
                '<div class="flex justify-between items-center text-sm">' +
                '<span class="text-green-700">' + breakdown.tax_name + ' (' + breakdown.tax_rate + '%):</span>' +
                '<span class="font-semibold text-green-800">' + (breakdown.tax_amount_formatted || '$' + breakdown.tax_amount.toFixed(2)) + '</span>' +
                '</div>';
        } else {
            // Si no hay impuestos, limpiar el desglose
            breakdownDiv.innerHTML = '';
        }
    }

    // Event listeners cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Vehicle exit script loaded');

        // Buscar vehículo
        const exitForm = document.getElementById('exit-form');
        if (exitForm) {
            exitForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                console.log('Search form submitted');

                const form = e.target;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;

                // Mostrar loading
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Buscando...';

                try {
                    const formData = new FormData(form);
                    console.log('Sending search request...');

                    const response = await fetch('/exit/', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: formData
                    });

                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    if (response.ok) {
                        // Llenar datos del vehículo
                        document.getElementById('placa').textContent = data.placa;
                        document.getElementById('entry_time').textContent = data.entry_time;
                        document.getElementById('duration').textContent = data.duration;
                        document.getElementById('ticket_id').value = data.ticket_id;

                        // El monto se actualizará en updatePaymentBreakdown

                        // Guardar en variables globales
                        currentTicketId = data.ticket_id;
                        currentAmount = data.amount;

                        // Actualizar desglose de impuestos
                        updatePaymentBreakdown(data.tax_breakdown);

                        // Mostrar resultado y ocultar búsqueda
                        document.getElementById('result').classList.remove('d-none');
                        document.getElementById('search-card').classList.add('d-none');

                        // Scroll to result
                        document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Error al procesar la salida',
                                confirmButtonColor: '#3B82F6'
                            });
                        } else {
                            alert('Error: ' + (data.error || 'Error al procesar la salida'));
                        }
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al procesar la solicitud',
                            confirmButtonColor: '#3B82F6'
                        });
                    } else {
                        alert('Error al procesar la solicitud');
                    }
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        }

        // Convertir input a mayúsculas
        const identifierInput = document.getElementById('identifier');
        if (identifierInput) {
            identifierInput.addEventListener('input', function () {
                this.value = this.value.toUpperCase();
            });
        }
    });
</script>
{% endblock %}