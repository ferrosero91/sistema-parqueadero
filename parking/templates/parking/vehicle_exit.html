{% extends 'parking/base.html' %}
{% load static %}
{% load parking_tags %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-red-50 via-white to-orange-50">
    <!-- Header Responsivo -->
    <div class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6">
            <div class="flex justify-between items-center py-3 sm:py-4 lg:py-6">
                <div class="flex items-center space-x-2 sm:space-x-3 lg:space-x-4">
                    <div class="flex items-center justify-center w-8 h-8 sm:w-10 sm:h-10 lg:w-12 lg:h-12 bg-gradient-to-r from-red-500 to-orange-600 rounded-lg sm:rounded-xl shadow-lg">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 lg:w-6 lg:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </div>
                    <div class="min-w-0 flex-1">
                        <h1 class="text-base sm:text-lg lg:text-xl font-bold text-gray-900 truncate">Salida de Vehículos</h1>
                        <p class="text-xs sm:text-sm text-gray-500 hidden sm:block">Procesar salida y cobro</p>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <a href="{% url 'dashboard' %}" class="inline-flex items-center px-2 sm:px-3 lg:px-4 py-1.5 sm:py-2 border border-gray-300 text-xs sm:text-sm font-medium rounded-md sm:rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors duration-200 shadow-sm">
                        <svg class="w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        <span class="hidden xs:inline">Volver</span>
                        <span class="xs:hidden">←</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="w-full max-w-4xl mx-auto px-3 sm:px-4 lg:px-6 py-3 sm:py-4 lg:py-6">
        <!-- Tarjeta de Búsqueda -->
        <div id="search-card" class="bg-white rounded-lg sm:rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-4 sm:mb-6">
            <!-- Encabezado de Búsqueda -->
            <div class="bg-gradient-to-r from-red-500 to-orange-600 px-3 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 lg:w-6 lg:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <div class="ml-2 sm:ml-3">
                        <h3 class="text-sm sm:text-base lg:text-lg font-semibold text-white">Buscar Vehículo</h3>
                        <p class="text-xs sm:text-sm text-red-100 opacity-90 hidden sm:block">Ingrese la placa o escanee el código</p>
                    </div>
                </div>
            </div>

            <!-- Contenido de Búsqueda -->
            <div class="px-3 sm:px-4 lg:px-6 py-4 sm:py-6">
                <form id="exit-form" class="space-y-4">
                    {% csrf_token %}
                    <div class="form-group">
                        <div class="p-3 sm:p-4 border border-gray-200 rounded-lg bg-gray-50/50 hover:bg-white transition-colors duration-200 shadow-sm hover:shadow-md">
                            <label class="block text-sm font-medium text-gray-700 mb-2 sm:mb-3">
                                <span class="flex items-center">
                                    <i class="fas fa-car text-red-500 mr-2"></i>
                                    Placa del Vehículo
                                    <span class="text-red-500 ml-1">*</span>
                                </span>
                            </label>
                            <div class="relative">
                                <input type="text" name="identifier" id="identifier" value="{{ placa }}" class="block w-full pl-10 pr-4 py-3 sm:py-3.5 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 rounded-lg shadow-sm bg-white transition-all duration-200 hover:border-gray-400 text-uppercase" required placeholder="Ingrese la placa o escanee el código" autofocus>
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-car text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-red-600 to-orange-600 text-white py-3.5 sm:py-4 px-4 sm:px-6 rounded-lg hover:from-red-700 hover:to-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center shadow-lg font-medium text-base sm:text-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                        <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        <span class="search-text">Buscar Vehículo</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Tarjeta de Resultado -->
        <div id="result" class="bg-white rounded-lg sm:rounded-xl shadow-lg border border-gray-200 overflow-hidden hidden">
            <!-- Encabezado de Resultado -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 px-3 sm:px-4 lg:px-6 py-3 sm:py-4">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 lg:w-6 lg:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="ml-2 sm:ml-3">
                        <h3 class="text-sm sm:text-base lg:text-lg font-semibold text-white">Resumen de Salida</h3>
                        <p class="text-xs sm:text-sm text-green-100 opacity-90 hidden sm:block">Complete los datos de pago</p>
                    </div>
                </div>
            </div>

            <!-- Contenido de Resultado -->
            <div class="px-3 sm:px-4 lg:px-6 py-4 sm:py-6">
                <!-- Información del Vehículo -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-3 sm:p-4 text-center border border-blue-200">
                        <div class="text-xs sm:text-sm text-blue-600 font-medium mb-1">Placa</div>
                        <div id="placa" class="text-lg sm:text-xl font-bold text-blue-900"></div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-3 sm:p-4 text-center border border-purple-200">
                        <div class="text-xs sm:text-sm text-purple-600 font-medium mb-1">Entrada</div>
                        <div id="entry_time" class="text-lg sm:text-xl font-bold text-purple-900"></div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-3 sm:p-4 text-center border border-orange-200">
                        <div class="text-xs sm:text-sm text-orange-600 font-medium mb-1">Tiempo</div>
                        <div id="duration" class="text-lg sm:text-xl font-bold text-orange-900"></div>
                    </div>
                </div>

                <!-- Desglose de Pago -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg border-2 border-green-200 p-4 sm:p-5 mb-4 sm:mb-6">
                    <div id="payment-breakdown" class="space-y-2 mb-3">
                        <!-- Se llenará dinámicamente con JavaScript -->
                    </div>
                    <!-- Total -->
                    <div class="flex justify-between items-center border-t-2 border-green-200 pt-3">
                        <span class="text-green-700 font-semibold text-base sm:text-lg">Total a Pagar:</span>
                        <span class="text-2xl sm:text-3xl font-bold text-green-800">$<span id="amount">0.00</span></span>
                    </div>
                </div>

                <!-- Formulario de Pago -->
                <form id="payment-form" method="POST" action="{% url 'print-exit-ticket' %}" class="space-y-4 sm:space-y-5">
                    {% csrf_token %}
                    <input type="hidden" name="ticket_id" id="ticket_id">

                    <!-- Campos de Pago en Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <!-- Monto Recibido -->
                        <div class="form-group">
                            <div class="p-3 sm:p-4 border border-gray-200 rounded-lg bg-gray-50/50 hover:bg-white transition-colors duration-200 shadow-sm hover:shadow-md">
                                <label class="block text-sm font-medium text-gray-700 mb-2 sm:mb-3">
                                    <span class="flex items-center">
                                        <i class="fas fa-dollar-sign text-green-500 mr-2"></i>
                                        Con cuánto pagó
                                        <span class="text-red-500 ml-1">*</span>
                                    </span>
                                </label>
                                <div class="relative">
                                    <input type="number" name="amount_received" id="amount_received" step="0.01" class="block w-full pl-10 pr-4 py-3 sm:py-3.5 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 rounded-lg shadow-sm bg-white transition-all duration-200 hover:border-gray-400" required placeholder="0.00" onkeyup="setTimeout(calculateChange, 100)" onchange="setTimeout(calculateChange, 100)" oninput="setTimeout(calculateChange, 100)">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-dollar-sign text-gray-400"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Forma de Pago -->
                        <div class="form-group">
                            <div class="p-3 sm:p-4 border border-gray-200 rounded-lg bg-gray-50/50 hover:bg-white transition-colors duration-200 shadow-sm hover:shadow-md">
                                <label class="block text-sm font-medium text-gray-700 mb-2 sm:mb-3">
                                    <span class="flex items-center">
                                        <i class="fas fa-credit-card text-blue-500 mr-2"></i>
                                        Forma de pago
                                        <span class="text-red-500 ml-1">*</span>
                                    </span>
                                </label>
                                <div class="relative">
                                    <select name="forma_pago" id="forma_pago" class="block w-full pl-10 pr-4 py-3 sm:py-3.5 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 rounded-lg shadow-sm bg-white transition-all duration-200 hover:border-gray-400" required>
                                        <option value="efectivo">Efectivo</option>
                                        <option value="datafono">Datáfono</option>
                                        <option value="transferencia">Transferencia</option>
                                        <option value="otro">Otro</option>
                                    </select>
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-credit-card text-gray-400"></i>
                                    </div>
                                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vuelto -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200 p-4 sm:p-5">
                        <div class="flex justify-between items-center">
                            <span class="text-blue-700 font-semibold text-base sm:text-lg flex items-center">
                                <i class="fas fa-hand-holding-usd text-blue-500 mr-2"></i>
                                Vuelto:
                            </span>
                            <span id="change" class="text-2xl sm:text-3xl font-bold text-blue-800">$0.00</span>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 pt-2">
                        <button type="button" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white py-3.5 sm:py-4 px-4 sm:px-6 rounded-lg hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center shadow-lg font-medium text-base sm:text-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" id="btn-cobrar" onclick="debugElements(); processPayment();">
                            <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <span class="payment-text">Cobrar y Imprimir</span>
                        </button>
                        <a href="{% url 'dashboard' %}" class="w-full bg-gray-100 text-gray-700 py-3.5 sm:py-4 px-4 sm:px-6 rounded-lg hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center shadow-sm font-medium text-base sm:text-lg border border-gray-300">
                            <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                            </svg>
                            Volver al Dashboard
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // Variables globales
    let currentTicketId = null;
    let currentAmount = 0;

    // Función para verificar elementos
    function debugElements() {
        console.log('=== DEBUG ELEMENTS ===');
        console.log('amount_received:', document.getElementById('amount_received'));
        console.log('amount:', document.getElementById('amount'));
        console.log('ticket_id:', document.getElementById('ticket_id'));
        console.log('change:', document.getElementById('change'));
        console.log('result div:', document.getElementById('result'));
        console.log('======================');
    }

    // Función para calcular el vuelto
    function calculateChange() {
        console.log('Calculating change...');

        try {
            // Verificar que el div result esté visible
            const resultDiv = document.getElementById('result');
            if (!resultDiv || resultDiv.classList.contains('d-none')) {
                console.log('Result div is hidden, skipping change calculation');
                return;
            }

            const amountReceivedInput = document.getElementById('amount_received');
            const amountElement = document.getElementById('amount');
            const changeElement = document.getElementById('change');

            if (!amountReceivedInput || !amountElement || !changeElement) {
                console.log('Required elements not found for change calculation');
                console.log('amountReceivedInput:', !!amountReceivedInput);
                console.log('amountElement:', !!amountElement);
                console.log('changeElement:', !!changeElement);
                return;
            }

            const amountReceived = parseFloat(amountReceivedInput.value) || 0;
            const amountToPay = parseFloat(amountElement.textContent) || 0;
            const change = amountReceived - amountToPay;

            console.log('Amount received:', amountReceived, 'Amount to pay:', amountToPay, 'Change:', change);

            changeElement.textContent = '$' + change.toFixed(2);

            // Cambiar color del vuelto según si es positivo o negativo
            if (change >= 0) {
                changeElement.className = 'text-2xl sm:text-3xl font-bold text-blue-800';
            } else {
                changeElement.className = 'text-2xl sm:text-3xl font-bold text-red-600';
            }
        } catch (error) {
            console.error('Error calculating change:', error);
        }
    }

    // Función para procesar el pago
    function processPayment() {
        console.log('Processing payment...');

        try {
            // Verificar que el div result esté visible
            const resultDiv = document.getElementById('result');
            if (!resultDiv || resultDiv.classList.contains('hidden')) {
                alert('Primero debe buscar un vehículo');
                return false;
            }

            const amountReceivedInput = document.getElementById('amount_received');
            const amountElement = document.getElementById('amount');
            const ticketIdInput = document.getElementById('ticket_id');

            if (!amountReceivedInput) {
                alert('No se encontró el campo de monto recibido. Verifique que haya buscado un vehículo primero.');
                return false;
            }

            if (!amountElement) {
                alert('No se encontró el monto a pagar. Verifique que haya buscado un vehículo primero.');
                return false;
            }

            if (!ticketIdInput) {
                alert('No se encontró el ID del ticket. Verifique que haya buscado un vehículo primero.');
                return false;
            }

            const amountReceived = parseFloat(amountReceivedInput.value) || 0;
            const amountToPay = parseFloat(amountElement.textContent) || 0;
            const ticketId = ticketIdInput.value;

            console.log('Payment data:', { amountReceived, amountToPay, ticketId });

            // Validaciones
            if (!ticketId) {
                alert('No se encontró el ID del ticket');
                return false;
            }

            if (!amountReceived || amountReceived <= 0) {
                alert('Debe ingresar un monto válido');
                return false;
            }

            if (amountReceived < amountToPay) {
                alert('El monto pagado debe ser mayor o igual al total a pagar');
                return false;
            }

            // Mostrar loading
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: 'Procesando pago...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });
            }

            // Enviar formulario
            const form = document.getElementById('payment-form');
            const formData = new FormData(form);

            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => {
                    console.log('Payment response status:', response.status);
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor: ' + response.status);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('Payment result:', result);

                    if (typeof Swal !== 'undefined') {
                        Swal.close();
                    }

                    if (result.success) {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'success',
                                title: '¡Salida registrada!',
                                text: 'El ticket de salida se abrirá en una nueva pestaña.',
                                confirmButtonColor: '#3B82F6'
                            }).then(() => {
                                // Abrir ticket en nueva pestaña
                                window.open(result.redirect_url, '_blank');

                                // Resetear formularios
                                resetForms();
                            });
                        } else {
                            alert('¡Salida registrada! El ticket se abrirá en una nueva pestaña.');
                            window.open(result.redirect_url, '_blank');
                            resetForms();
                        }
                    } else {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: result.error || 'Error al procesar el pago',
                                confirmButtonColor: '#3B82F6'
                            });
                        } else {
                            alert('Error: ' + (result.error || 'Error al procesar el pago'));
                        }
                    }
                })
                .catch(error => {
                    console.error('Payment error:', error);

                    if (typeof Swal !== 'undefined') {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de conexión',
                            text: 'No se pudo procesar el pago. Intente nuevamente.',
                            confirmButtonColor: '#3B82F6'
                        });
                    } else {
                        alert('Error de conexión: No se pudo procesar el pago. Intente nuevamente.');
                    }
                });

        } catch (error) {
            console.error('Error in processPayment:', error);
            alert('Error al procesar el pago: ' + error.message);
        }

        return false;
    }

    // Función para resetear formularios
    function resetForms() {
        try {
            document.getElementById('payment-form').reset();
            document.getElementById('result').classList.add('hidden');
            document.getElementById('search-card').classList.remove('hidden');
            document.getElementById('exit-form').reset();
            document.getElementById('identifier').focus();
            document.getElementById('change').textContent = '$0.00';
            document.getElementById('change').className = 'text-2xl sm:text-3xl font-bold text-blue-800';
        } catch (error) {
            console.error('Error resetting forms:', error);
        }
    }

    // Función para actualizar el desglose de pago
    function updatePaymentBreakdown(breakdown) {
        const breakdownDiv = document.getElementById('payment-breakdown');
        const amountElement = document.getElementById('amount');

        if (!breakdownDiv || !amountElement) return;

        // Actualizar el elemento amount
        if (breakdown && breakdown.total_amount) {
            amountElement.textContent = breakdown.total_amount.toFixed(2);
        }

        // Actualizar el desglose
        if (breakdown && breakdown.has_tax) {
            breakdownDiv.innerHTML =
                '<div class="flex justify-between items-center text-sm">' +
                '<span class="text-green-700">Subtotal:</span>' +
                '<span class="font-semibold text-green-800">' + (breakdown.subtotal_formatted || '$' + breakdown.subtotal.toFixed(2)) + '</span>' +
                '</div>' +
                '<div class="flex justify-between items-center text-sm">' +
                '<span class="text-green-700">' + breakdown.tax_name + ' (' + breakdown.tax_rate + '%):</span>' +
                '<span class="font-semibold text-green-800">' + (breakdown.tax_amount_formatted || '$' + breakdown.tax_amount.toFixed(2)) + '</span>' +
                '</div>';
        } else {
            // Si no hay impuestos, limpiar el desglose
            breakdownDiv.innerHTML = '';
        }
    }

    // Event listeners cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Vehicle exit script loaded');

        // Buscar vehículo
        const exitForm = document.getElementById('exit-form');
        if (exitForm) {
            exitForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                console.log('Search form submitted');

                const form = e.target;
                const submitButton = form.querySelector('button[type="submit"]');
                const originalText = submitButton.innerHTML;

                // Mostrar loading
                submitButton.disabled = true;
                submitButton.innerHTML = `
                    <svg class="w-5 h-5 mr-3 animate-spin flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span class="search-text">Buscando...</span>
                `;

                try {
                    const formData = new FormData(form);
                    console.log('Sending search request...');

                    const response = await fetch('/exit/', {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: formData
                    });

                    console.log('Response status:', response.status);
                    const data = await response.json();
                    console.log('Response data:', data);

                    if (response.ok) {
                        // Llenar datos del vehículo
                        document.getElementById('placa').textContent = data.placa;
                        document.getElementById('entry_time').textContent = data.entry_time;
                        document.getElementById('duration').textContent = data.duration;
                        document.getElementById('ticket_id').value = data.ticket_id;

                        // El monto se actualizará en updatePaymentBreakdown

                        // Guardar en variables globales
                        currentTicketId = data.ticket_id;
                        currentAmount = data.amount;

                        // Actualizar desglose de impuestos
                        updatePaymentBreakdown(data.tax_breakdown);

                        // Mostrar resultado y ocultar búsqueda
                        document.getElementById('result').classList.remove('hidden');
                        document.getElementById('search-card').classList.add('hidden');

                        // Scroll to result
                        document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
                    } else {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.error || 'Error al procesar la salida',
                                confirmButtonColor: '#3B82F6'
                            });
                        } else {
                            alert('Error: ' + (data.error || 'Error al procesar la salida'));
                        }
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al procesar la solicitud',
                            confirmButtonColor: '#3B82F6'
                        });
                    } else {
                        alert('Error al procesar la solicitud');
                    }
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        }

        // Convertir input a mayúsculas
        const identifierInput = document.getElementById('identifier');
        if (identifierInput) {
            identifierInput.addEventListener('input', function () {
                this.value = this.value.toUpperCase();
            });
        }
    });
</script>

<style>
    /* Estilos base para inputs */
    input[type="text"], 
    input[type="number"], 
    select {
        padding: 0.75rem 0.75rem 0.75rem 2.5rem !important;
        font-size: 16px !important; /* Previene zoom en iOS */
        min-height: 48px !important;
        border-radius: 0.5rem !important;
        border: 1px solid #d1d5db !important;
        background-color: white !important;
        transition: all 0.2s ease-in-out !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }

    input[type="text"]:focus, 
    input[type="number"]:focus, 
    select:focus {
        outline: none !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important;
    }

    /* Clase para texto en mayúsculas */
    .text-uppercase {
        text-transform: uppercase !important;
    }

    /* Breakpoint para pantallas extra pequeñas */
    @media (max-width: 375px) {
        .max-w-4xl {
            max-width: 100% !important;
            margin: 0 !important;
        }
        
        .px-3 {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
        
        .rounded-lg, .rounded-xl {
            border-radius: 0.5rem !important;
        }
        
        .form-group > div {
            padding: 0.75rem !important;
        }
        
        .text-base {
            font-size: 0.875rem !important;
        }
    }

    /* Breakpoint para móviles */
    @media (max-width: 640px) {
        .max-w-4xl {
            max-width: 96% !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        
        /* Grid responsivo para campos de pago */
        .grid-cols-1.sm\\:grid-cols-2 {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }
        
        /* Grid responsivo para información del vehículo */
        .grid-cols-1.sm\\:grid-cols-3 {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }
        
        /* Espaciado optimizado */
        .space-y-4 > * + * {
            margin-top: 1rem !important;
        }
        
        /* Botones optimizados para móvil */
        button, a.w-full {
            padding: 1rem !important;
            font-size: 1rem !important;
            min-height: 56px !important;
            border-radius: 0.75rem !important;
        }
        
        /* Header sticky optimizado */
        .sticky {
            position: -webkit-sticky !important;
            position: sticky !important;
        }
        
        /* Mejorar legibilidad en móviles */
        label {
            font-size: 0.875rem !important;
            font-weight: 500 !important;
        }
        
        /* Iconos más pequeños en móvil */
        .fas {
            font-size: 0.875rem !important;
        }
        
        /* Texto de totales más pequeño en móvil */
        .text-2xl {
            font-size: 1.5rem !important;
        }
        
        .text-3xl {
            font-size: 1.875rem !important;
        }
    }

    /* Breakpoint para tablets */
    @media (min-width: 641px) and (max-width: 1024px) {
        .max-w-4xl {
            max-width: 90% !important;
        }
        
        /* Grid de 2 columnas para campos de pago */
        .grid-cols-1.sm\\:grid-cols-2 {
            grid-template-columns: 1fr 1fr !important;
            gap: 1rem !important;
        }
        
        /* Grid de 3 columnas para información del vehículo */
        .grid-cols-1.sm\\:grid-cols-3 {
            grid-template-columns: 1fr 1fr 1fr !important;
            gap: 1rem !important;
        }
    }

    /* Breakpoint para desktop */
    @media (min-width: 1025px) {
        .max-w-4xl {
            max-width: 56rem !important;
        }
        
        /* Hover effects solo en desktop */
        .form-group > div:hover {
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        }
        
        button:hover, a:hover {
            transform: translateY(-1px) scale(1.02) !important;
        }
    }

    /* Animaciones suaves */
    .form-group > div {
        transition: all 0.2s ease-in-out !important;
    }

    /* Estados de loading */
    .loading input,
    .loading select,
    .loading button {
        pointer-events: none !important;
        opacity: 0.7 !important;
    }

    /* Mejoras de accesibilidad */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
    }

    /* Focus visible mejorado */
    input:focus-visible,
    select:focus-visible,
    button:focus-visible {
        outline: 2px solid #3b82f6 !important;
        outline-offset: 2px !important;
    }

    /* Indicador de campo requerido */
    .text-red-500 {
        color: #ef4444 !important;
        font-weight: 600 !important;
    }

    /* Mejoras para select en móviles */
    select {
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
        background-image: none !important;
    }

    /* Estilos para pantallas de alta densidad */
    @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        }
    }

    /* Animación para mostrar/ocultar tarjetas */
    .hidden {
        display: none !important;
    }

    /* Gradientes personalizados */
    .bg-gradient-to-br {
        background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)) !important;
    }

    /* Mejoras para notificaciones */
    .notification {
        z-index: 9999 !important;
        pointer-events: auto !important;
    }
</style>

{% endblock %}